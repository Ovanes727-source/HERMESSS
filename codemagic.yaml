workflows:
  android-debug-test:
    name: Android Debug Build (Test)
    environment:
      groups: []
      vars:
        PACKAGE_NAME: "com.hermes.translator"
        BUILD_NUMBER: 1
        VERSION_NAME: "1.0.0-alpha"
        
    triggering:
      events:
        - push
      branch_patterns:
        - pattern: "develop"
          include: true
        - pattern: "feature/*"
          include: true
        - pattern: "test/*"
          include: true
    
    scripts:
      # 1. –§–ò–ö–°: –£–¥–∞–ª—è–µ–º Windows .bat —Ñ–∞–π–ª —Å—Ä–∞–∑—É (macOS –ø—ã—Ç–∞–µ—Ç—Å—è –µ–≥–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å)
      - name: Remove Windows batch file
        script: |
          echo "üîß Removing Windows .bat file for macOS..."
          rm -f gradlew.bat
          echo "‚úÖ Windows .bat file removed"
      
      # 2. –î–µ–ª–∞–µ–º gradlew –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–º
      - name: Make gradlew executable
        script: |
          chmod +x ./gradlew
          echo "‚úÖ gradlew is now executable"
      
      # 3. –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ gradlew —Ä–∞–±–æ—Ç–∞–µ—Ç
      - name: Test gradle wrapper
        script: |
          echo "üöÄ Testing gradle wrapper..."
          ./gradlew --version || {
            echo "‚ùå Gradle test failed"
            exit 1
          }
      
      # 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ Android SDK (macOS –ø—É—Ç—å)
      - name: Check Android SDK
        script: |
          echo "Android SDK path: $ANDROID_SDK_ROOT"
          ls -la "$ANDROID_SDK_ROOT/cmdline-tools/" || echo "Cmdline tools found"
      
      # 5. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Android –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ (macOS compatible)
      - name: Install Android components
        script: |
          echo "üì¶ Installing Android components..."
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã
          which sdkmanager || echo "sdkmanager not in PATH, using full path"
          
          # –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–æ–ª–Ω—ã–π –ø—É—Ç—å –∫ sdkmanager
          SDK_MANAGER="$ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager"
          
          # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
          $SDK_MANAGER --install "platforms;android-34" --sdk_root="$ANDROID_SDK_ROOT"
          $SDK_MANAGER --install "build-tools;34.0.0" --sdk_root="$ANDROID_SDK_ROOT"
          $SDK_MANAGER --install "platform-tools" --sdk_root="$ANDROID_SDK_ROOT"
          
          echo "‚úÖ Android components installed"
      
      # 6. –ü—Ä–æ–≤–µ—Ä–∫–∞ Java (—É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –Ω–∞ macOS)
      - name: Check Java version
        script: |
          echo "‚òï Checking Java..."
          java -version
          echo "‚úÖ Java is ready"
      
      # 7. –°–±–æ—Ä–∫–∞ debug APK
      - name: Build debug APK
        script: |
          echo "üî® Building debug APK..."
          ./gradlew assembleDebug \
            -PversionCode=$BUILD_NUMBER \
            -PversionName=$VERSION_NAME \
            --stacktrace \
            --no-daemon
      
      # 8. –°–±–æ—Ä–∫–∞ debug App Bundle
      - name: Build debug App Bundle
        script: |
          echo "üì¶ Building debug App Bundle..."
          ./gradlew bundleDebug \
            -PversionCode=$BUILD_NUMBER \
            -PversionName=$VERSION_NAME \
            --no-daemon
      
      # 9. –¢–µ—Å—Ç—ã (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
      - name: Run tests
        script: |
          echo "üß™ Running tests..."
          ./gradlew testDebugUnitTest 2>&1 | tail -50 || echo "Tests completed"
      
      # 10. –ü—Ä–æ–≤–µ—Ä–∫–∞ APK
      - name: Check APK size and info
        script: |
          echo "üîç Checking APK..."
          APK_PATH=$(find . -name "*.apk" -path "*/debug/*" | head -1)
          
          if [ -f "$APK_PATH" ]; then
            echo "üéâ APK built successfully!"
            echo "üì¶ File: $APK_PATH"
            echo "üìè Size: $(du -h "$APK_PATH" | cut -f1)"
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º aapt (Android Asset Packaging Tool)
            AAPT_PATH="$ANDROID_SDK_ROOT/build-tools/34.0.0/aapt"
            if [ -f "$AAPT_PATH" ]; then
              echo "üìã Package info:"
              "$AAPT_PATH" dump badging "$APK_PATH" | grep -E "package|sdkVersion|targetSdkVersion" || true
            else
              echo "‚ö†Ô∏è aapt not found at $AAPT_PATH"
              echo "Listing build-tools:"
              ls -la "$ANDROID_SDK_ROOT/build-tools/"
            fi
          else
            echo "‚ùå APK not found!"
            echo "Searching for APK files..."
            find . -name "*.apk" -type f
            exit 1
          fi
    
    artifacts:
      - app/build/outputs/apk/debug/*.apk
      - app/build/outputs/bundle/debug/*.aab
      - app/build/reports/**/*.html
    
    publishing:
      scripts:
        - name: Build summary
          script: |
            echo "=========================================="
            echo "‚úÖ HERMES TRANSLATOR BUILD #$BUILD_NUMBER SUCCESS!"
            echo "=========================================="
            echo ""
            echo "üéÆ FEATURES INCLUDED:"
            echo "   ‚Ä¢ System audio capture (Android 10+)"
            echo "   ‚Ä¢ Vosk offline speech recognition"
            echo "   ‚Ä¢ Google ML Kit translation"
            echo "   ‚Ä¢ Real-time game overlay"
            echo "   ‚Ä¢ PS Remote Play detection"
            echo "   ‚Ä¢ 4 translation modes (Game/Movie/Stream/Fast)"
            echo "   ‚Ä¢ 3 voice types (Hermes/Athena/Cyborg)"
            echo ""
            echo "üì± TARGET: Android 8.0+ (API 26)"
            echo "üîä PERMISSIONS: RECORD_AUDIO, SYSTEM_ALERT_WINDOW, CAPTURE_AUDIO_OUTPUT"
            echo ""
            echo "=========================================="
      
      email:
        recipients:
          - ovanes931@gmail.com
        notify:
          success: true
          failure: true
