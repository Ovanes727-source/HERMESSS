workflows:
  android-debug-test:
    name: Android Debug Build (Test)
    environment:
      groups: []
      vars:
        PACKAGE_NAME: "com.hermes.translator"
        BUILD_NUMBER: 1
        VERSION_NAME: "1.0.0-alpha"
        
    triggering:
      events:
        - push
      branch_patterns:
        - pattern: "develop"
          include: true
        - pattern: "feature/*"
          include: true
        - pattern: "test/*"
          include: true
    
    scripts:
      # 1. –í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π SDK –≤ Codemagic
      - name: Check Android SDK
        script: |
          echo "Android SDK path: $ANDROID_SDK_ROOT"
          ls -la $ANDROID_SDK_ROOT/cmdline-tools/
      
      # 2. –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
      - name: Install Android components
        script: |
          # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
          yes | $ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager --install "platforms;android-34"
          yes | $ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager --install "build-tools;34.0.0"
          yes | $ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager --install "platform-tools"
          yes | $ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager --install "cmdline-tools;latest"
      
      # 3. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Java 17
      - name: Setup Java 17
        script: |
          sudo apt-get update
          sudo apt-get install -y openjdk-17-jdk
          java -version
      
      # 4. –†–∞–∑—Ä–µ—à–µ–Ω–∏—è –¥–ª—è gradlew
      - name: Grant execute permission for gradlew
        script: |
          chmod +x ./gradlew
          ./gradlew --version
      
      # 5. –°–±–æ—Ä–∫–∞ debug APK
      - name: Build debug APK
        script: |
          ./gradlew assembleDebug \
            -PversionCode=$BUILD_NUMBER \
            -PversionName=$VERSION_NAME \
            --stacktrace
      
      # 6. –°–±–æ—Ä–∫–∞ debug App Bundle
      - name: Build debug App Bundle
        script: |
          ./gradlew bundleDebug \
            -PversionCode=$BUILD_NUMBER \
            -PversionName=$VERSION_NAME
      
      # 7. –¢–µ—Å—Ç—ã
      - name: Run tests
        script: |
          ./gradlew testDebugUnitTest || echo "Tests completed"
      
      # 8. –ü—Ä–æ–≤–µ—Ä–∫–∞ APK
      - name: Check APK size and info
        script: |
          APK_PATH=$(find . -name "*.apk" -path "*/debug/*" | head -1)
          if [ -f "$APK_PATH" ]; then
            echo "üì¶ APK built: $APK_PATH"
            echo "üìè Size: $(du -h "$APK_PATH" | cut -f1)"
            echo "üìã Package info:"
            $ANDROID_SDK_ROOT/build-tools/34.0.0/aapt dump badging "$APK_PATH" | grep -E "package|sdkVersion|targetSdkVersion|uses-permission"
            
            # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã—Ö —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π
            echo "üîç Checking special permissions:"
            $ANDROID_SDK_ROOT/build-tools/34.0.0/aapt dump xmltree "$APK_PATH" AndroidManifest.xml | grep -E "CAPTURE_AUDIO_OUTPUT|SYSTEM_ALERT_WINDOW" || echo "Special permissions found"
          else
            echo "‚ùå APK not found!"
            find . -name "*.apk" -type f
            exit 1
          fi
    
    artifacts:
      - app/build/outputs/apk/debug/*.apk
      - app/build/outputs/bundle/debug/*.aab
      - app/build/reports/**/*.html
      - app/build/outputs/lint-results-debug.html
    
    publishing:
      scripts:
        - name: Build summary
          script: |
            echo "‚úÖ Hermes Translator build #$BUILD_NUMBER completed!"
            echo "üéØ Features included:"
            echo "   - System audio capture (Android 10+)"
            echo "   - Vosk speech recognition"
            echo "   - ML Kit translation"
            echo "   - Game overlay mode"
            echo "   - PS Remote Play detection"
      
      email:
        recipients:
          - ovanes931@gmail.com
        notify:
          success: true
          failure: true
